define(["require","exports","tslib","react","external/lodash","external/react-redux","spectrum/popover","modules/clean/previews/data/selectors","modules/clean/previews/util","modules/clean/react/bubble_dropdown_v2","modules/clean/react/file_action_button_type","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/data/selectors","file-viewer/core","modules/clean/react/file_viewer/files2_utils","modules/clean/react/file_viewer/utils","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_viewer/more_dropdown/views","modules/clean/react/size_class/constants","modules/clean/file_store/utils","modules/clean/react/title_bar/overflow_menu","modules/core/browser","modules/core/i18n","modules/clean/react/paper/utils","react-dom","modules/clean/react/paper/open_in_paper_callout_loader","modules/clean/react/paper/open_in_paper_button","modules/clean/react/file_viewer/data/actions","modules/clean/previews/util","modules/clean/react/extensions/download_intercept","modules/clean/react/extensions/data/action_creators","modules/clean/react/watermarking/callout","modules/clean/react/watermarking/utils"],function(e,t,o,r,n,i,a,l,s,c,p,u,d,m,f,_,g,h,v,w,C,k,A,I,M,b,y,O,S,F,P,E,D,B,R){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r=o.__importDefault(r),n=o.__importStar(n),s=o.__importStar(s),y=o.__importStar(y);var T=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state=t.getStateFromRegistry(),t.onRegistryUpdate=function(){t.setState(t.getStateFromRegistry())},t.handleDownloadClick=function(e){e.preventDefault(),F.download(t.props.file);var o=t.props.setInDownloadInterceptFlow;if(t.props.extensionsConfig&&k.isBrowseFile(t.props.file)&&t.props.user&&o&&t.props.sizeClass===C.SizeClass.Large){var r=function(){o({inDownloadInterceptFlow:!0})};E.onDownloadFile(t.props.extensionsConfig,t.props.user,t.props.file.ext,r)}return u.logUserAction(d.UserAction.Download,d.UserActionContext.TitleBarMore)},t.handleRemoveLinkClick=function(e){e.preventDefault(),t.props.onRemoveShareLink&&(t.props.onRemoveShareLink(),u.logUserAction(d.UserAction.RemoveLink,d.UserActionContext.TitleBarMore))},t.handlePreviousVersionClick=function(e){if(e.preventDefault(),!t.props.user)throw new Error("User not specified");return s.redirectToVersionHistory(t.props.file,t.props.user),u.logUserAction(d.UserAction.ViewRevisions,d.UserActionContext.TitleBarMore)},t.handleSignInClick=function(e){e.preventDefault(),u.logUserAction(d.UserAction.SignIn,d.UserActionContext.TitleBarMore),I.redirect(g.getSharedLinkLoginUrl())},t.handleWatermarkingModeToggle=function(e){return o.__awaiter(t,void 0,void 0,function(){var t,r,n;return o.__generator(this,function(o){return e.preventDefault(),t=this.props,r=t.mode,(n=t.changeMode)?(r===f.FileViewerMode.Watermarking?(u.logUserAction(d.UserAction.WatermarkCancel,d.UserActionContext.TitleBarMore),n(f.FileViewerMode.Default)):(u.logUserAction(d.UserAction.WatermarkEnable,d.UserActionContext.TitleBarMore),n(f.FileViewerMode.Watermarking)),[2]):[2]})})},t.handleOpenInPaperClick=function(e){e.preventDefault();var o={file:t.props.file,user:t.props.user,sharedLink:t.props.sharedLink,fromModal:!1};b.openFileInPaper(o)},t.handleClick=function(){t.setState({hasBeenClicked:!0})},t}return o.__extends(t,e),t.prototype.componentDidMount=function(){this.removeRegistryListener=v.moreOptionRegistry.addListener(this.onRegistryUpdate)},t.prototype.componentWillUnmount=function(){this.removeRegistryListener()},t.prototype.getStateFromRegistry=function(){var e=this.state||{hasBeenClicked:!1,registeredItems:[]},t=o.__assign({},e,{registeredItems:v.moreOptionRegistry.getOptionItems()}),r=this.getOptionItemsContent(t.registeredItems),i=this.getOptionItemsContent(e.registeredItems);return n.isEqual(r,i)||(t.hasBeenClicked=!1),t},t.prototype.getOptionItemsContent=function(e){var t=this;return e.reduce(function(e,o){return o instanceof h.MoreOption?e.push(t.getMoreOptionContent(o)):e=e.concat(o.options.map(t.getMoreOptionContent)),e},[])},t.prototype.getMoreOptionContent=function(e){return p.getFileActionButtonText(e.fileActionButtonType)},t.prototype.getPopoverContent=function(){var e=this.props,t=e.allowRemoveLink,o=e.isPrivate,n=e.mode,i=e.onRemoveShareLink,l=e.renderSignIn,s=e.shareDownloadOptions,c=e.sizeClass,u=e.showOpenInPaper,d=e.file,m=e.user,g=[],h=c===C.SizeClass.Small,v=c===C.SizeClass.Medium,k=c===C.SizeClass.Large;if(o&&v&&g.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__share",key:"more-button__share",onSelect:this.props.onClickShareLink},p.getFileActionButtonText(p.FileActionButtonType.SHARE))),null!=i&&t&&!h&&g.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__remove",key:"more-button__remove",onSelect:this.handleRemoveLinkClick},p.getFileActionButtonText(p.FileActionButtonType.REMOVE_LINK))),o&&!P.isCloudDocPreview(d)&&g.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__download",key:"more-button__download",onSelect:this.handleDownloadClick},p.getFileActionButtonText(p.FileActionButtonType.DOWNLOAD))),s&&!P.isCloudDocPreview(d))for(var I=0,b=s;I<b.length;I++){var y=b[I];if(!y.isDisabled){var O="more-button-sl__"+y.userAction;g.push(r.default.createElement(L,{handler:y.handler,key:O,text:y.text,userAction:y.userAction}))}}if(o&&!h&&g.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__version-history",key:"more-button__version-history",onSelect:this.handlePreviousVersionClick},p.getFileActionButtonText(p.FileActionButtonType.PREVIOUS_VERSIONS))),k&&!P.isCloudDocPreview(d)){var F=w.getPopoverOrMobileItemsForMoreOptions(this.state.registeredItems);g=g.concat(F)}if(!_.isFiles2WatermarkingEnabled(m)&&R.allowWatermark(d,m)){g.push(r.default.createElement(a.PopoverContentSeparator,{key:"more_button__separator2"}));var E=n===f.FileViewerMode.Watermarking?p.FileActionButtonType.REMOVE_WATERMARKING:p.FileActionButtonType.ENABLE_WATERMARKING;g.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__watermarking-toggle",key:"more-button__watermarking-toggle",onSelect:this.handleWatermarkingModeToggle},p.getFileActionButtonText(E)))}return l&&g.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__sign-in",key:"more-button__sign-in",onSelect:this.handleSignInClick},P.isCloudDocPreview(d)?M._("Edit now"):M._("Sign in"))),u&&(k&&g.length&&this.state.registeredItems.length&&g.push(r.default.createElement(a.PopoverContentSeparator,{key:"more_button__separator2"})),g.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__open-in-paper",key:"more-button__open-in-paper",onSelect:this.handleOpenInPaperClick},r.default.createElement(S.OpenInPaperButtonInMoreDropdown,{file:d,handleOpenInPaperClick:this.handleOpenInPaperClick,sizeClass:c})))),g},t.prototype.render=function(){var e=this,t=this.props,o=t.file,n=t.sizeClass,i=t.showOpenInPaper,a=t.user,l=this.state.hasBeenClicked;return r.default.createElement("div",{ref:function(t){e.ref=y.findDOMNode(t)},onClick:this.handleClick},r.default.createElement(A.OverflowMenu,{contentWrapperClassName:"react-file-viewer-dropdown",hideOnDisabled:P.isCloudDocPreview(o)},this.getPopoverContent()),i?r.default.createElement(O.OpenInPaperCalloutLoader,{file:o,parentHasBeenClicked:l,sizeClass:n,targetNode:this.ref,user:a,variant:b.OpenInPaperButtonVariant.Ellipsis}):null,!_.isFiles2WatermarkingEnabled(a)&&R.allowWatermark(o,a)?r.default.createElement(B.WatermarkingCallout,{targetNode:this.ref,parentHasBeenClicked:l,position:c.BubbleDropdownPositions.BOTTOM_LEFT}):null)},t})(r.default.Component);t._MoreDropdown=T;var x=function(e){var t=m.getActiveFile(e);return{isFileRendered:m.getRenderStatusForCurrentFile(e)===d.PreviewRenderStatus.Succeeded,mode:m.getMode(e),previewApiData:l.getApiDataForFile(e,t)}},U=i.connect(x,{changeMode:F.changeMode,setInDownloadInterceptFlow:D.setInDownloadInterceptFlow})(T);t.MoreDropdown=U;var L=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.handleClick=function(){var e=t.props,o=e.handler,r=e.userAction;u.logUserAction(r,d.UserActionContext.TitleBarMore),o()},t}return o.__extends(t,e),t.prototype.render=function(){var e=this.props.text;return r.default.createElement(A.PopoverOrMobileItem,{onSelect:this.handleClick},e)},t})(r.default.PureComponent)});
//# sourceMappingURL=more_dropdown.min.js-vfl-wi5iB.map